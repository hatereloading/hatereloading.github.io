author: [@relooadin / X](https://x.com/relooadin)
2024-06-03 17:09:52
**Shout out to [@buptsb](https://x.com/buptsb) and [@mistymntncop](https://x.com/mistymntncop) for their brilliant work.**

# 漏洞信息
[Chrome Releases: Stable Channel Update for Desktop (googleblog.com)](https://chromereleases.googleblog.com/2024/05/stable-channel-update-for-desktop_13.html)
CVE-2024-4761是V8越界写入漏洞，攻击者可以通过构造恶意代码达成渲染进程RCE（沙箱内）。谷歌在发布的Chrome版本 124.0.6367.207 中修复了该漏洞。
commit：`[wasm-gc] Only normalize JSObject targets in SetOrCopyDataProperties`
[[wasm-gc] Only normalize JSObject targets in SetOrCopyDataProperties (5527397) · Gerrit Code Review (googlesource.com)](https://chromium-review.googlesource.com/c/v8/v8/+/5527397)

根据补丁信息及X上已公开的POC (作者: @buptdsb)可知，该漏洞是由 `SetOrCopyDataProperties` 函数在转换属性存储模式过程中校验不充分造成的越界写。


# 关于补丁
[[wasm-gc] Only normalize JSObject targets in SetOrCopyDataProperties (5527397) · Gerrit Code Review (googlesource.com)](https://chromium-review.googlesource.com/c/v8/v8/+/5527397)
* 在 `JSReceiver::SetOrCopyDataProperties` 函数中
* 当descriptor长度大于1020时，将快属性转化为慢属性。
* 该补丁使非`JSObject`的对象无法进入泛化逻辑
* 从标题来看重点针对`wasm-gc`对象

简单地说就是新引入的`WasmObject` 对象不该进入`JSReceiver::SetOrCopyDataProperties`的 Normalize 逻辑。

# POC分析

![image](https://github.com/user-attachments/assets/fd044ded-fb14-49c3-889c-d28868b161c8)
prototype 为null(0x85) 
会在这里崩溃
![image](https://github.com/user-attachments/assets/c440c598-d4a7-4cfe-8829-b709aab86bea)
inobject 个数计算
![image](https://github.com/user-attachments/assets/daa655f1-dc23-4760-b730-eafd7a923788)

![image](https://github.com/user-attachments/assets/a1181b17-d6b1-4cbd-849f-bdbe25a9cd31)
![image](https://github.com/user-attachments/assets/528026ab-340e-4a56-9e24-7afc6db5bb0c)
![image](https://github.com/user-attachments/assets/1ff71a17-34bf-40e9-a8de-ba1193cefdac)

[src/objects/map.h - v8/v8 - Git at Google (googlesource.com)](https://chromium.googlesource.com/v8/v8/+/70bd7cf0ef618621c16ae3f5ba2db614ac8ef996/src/objects/map.h)

# OOB
inobject被计算为4，前4个32bit被抹零

所以会进入 `GetRootForNonJSReceiver`
![image](https://github.com/user-attachments/assets/0d7de4fa-f3ba-4e14-bd95-59ee5e625787)
![image](https://github.com/user-attachments/assets/76472420-64ec-4b04-b605-7d1916ffe8c8)
![image](https://github.com/user-attachments/assets/19824eca-1f0d-4aa5-8cdf-e83cab5b1907)



# 重入JS
在这里切回js
![image](https://github.com/user-attachments/assets/be2f58a1-54b4-4bad-9aed-edf345faa754)
![image](https://github.com/user-attachments/assets/3270a70f-b71d-4c9d-b493-373d939b0b05)
截图来自：[CVE-2024-4761.js (github.com)](https://gist.github.com/mistymntncop/2cb449eb6aa30d35d1afd78a8b06bac2)
很多与对象属性访问相关的历史漏洞（如CVE-2021-30551）都使用过“重入JS用户代码”的模式

# 利用
@buptsb 与 @mistymntncop 已公开利用方法：
[CVE-2024-4947: v8 incorrect AccessInfo for module namespace object causes Maglev type confusion (buptsb.github.io)](https://buptsb.github.io/blog/post/CVE-2024-4947-%20v8%20incorrect%20AccessInfo%20for%20module%20namespace%20object%20causes%20Maglev%20type%20confusion.html)
[CVE-2024-4761: v8 missing check of WasmObject type cast causes type confusion and OOB access (buptsb.github.io)](https://buptsb.github.io/blog/post/CVE-2024-4761-%20v8%20missing%20check%20of%20WasmObject%20type%20cast%20causes%20type%20confusion%20and%20OOB%20access.html)

被清空0~0x10的wasm_array会被识别成字符串
![image](https://github.com/user-attachments/assets/2755b159-aa49-4ea8-9582-19defae09ab8)

gc会把 0xf2000 00000000 当做map
As the `instance_type` is 0 for now, it’s `INTERNALIZED_TWO_BYTE_STRING_TYPE`,
so we will call `CALL_APPLY(SeqTwoByteString)` to gc this object.
![image](https://github.com/user-attachments/assets/cb368886-9b4c-4c57-b47a-726016847f77)
![image](https://github.com/user-attachments/assets/f97480b6-586c-4195-8bcf-caef8c86f9c4)

越界写，把o.property's map覆盖为0
![image](https://github.com/user-attachments/assets/58cfd618-b794-4137-86b8-13b08323bcf5)
随后GC，使 `o' property` 与 `arr1` 重叠，通过访问o的属性更改 `arr1` 的 `length`。
![image](https://github.com/user-attachments/assets/bb5813cb-8b9a-494d-9579-bb60f362103e)
![image](https://github.com/user-attachments/assets/a3ffeaf6-bb2a-4eba-aad8-b600588eb132)
![image](https://github.com/user-attachments/assets/0ff0a5d8-94d9-46a1-9490-6139a1fda761)

# SeqTwoByteString 
双字节字符
 V8 的源代码中，有一个[方便查阅的列表](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fv8%2Fv8%2Fblob%2F941b945b%2Fsrc%2Fobjects%2Fobjects.h%23L134-L151 "https://github.com/v8/v8/blob/941b945b/src/objects/objects.h#L134-L151")，列出了它使用的所有字符串实现：
 从 string.tq 一直往在追，SeqTwoByteString 的内存表示为：
`map: Map | raw_hash_field: NameHash | length: int32 | chars[length]: char16`
的形式

**map为0的对象会被识别成 SeqTwoByteString**， 由于instance_type为0，即`*(base+8) = 0 `
![image](https://github.com/user-attachments/assets/2158a6d8-50e1-46d4-aa87-cab25f23507d)

原因如下：
![image](https://github.com/user-attachments/assets/94a4e805-7b56-4583-b7ac-eefd2894936e)
截图来自：[CVE-2024-4947: v8 incorrect AccessInfo for module namespace object causes Maglev type confusion (buptsb.github.io)](https://buptsb.github.io/blog/post/CVE-2024-4947-%20v8%20incorrect%20AccessInfo%20for%20module%20namespace%20object%20causes%20Maglev%20type%20confusion.html)
![image](https://github.com/user-attachments/assets/e3fe8368-99d5-48f2-81e4-6feb4bab229f)
源码参考：[string.tq - Chromium Code Search](https://source.chromium.org/chromium/chromium/src/+/main:v8/src/objects/string.tq)


# 总结
1. wasm-gc对象在`SetOrCopyDataProperties`函数中被`normalize`时发生oob（被当做JSObject）
2. 越界写的内容和范围： map_base+5 ~ map_base+4 范围内置零，对于Wasm Array，该对象后紧接着的一个32位会被越界置零。
3. 利用   property array reallocates 布局内存，使一个fast property（`properties[0]=0`）紧随  Wasm Array
4. 触发漏洞，**fast property 的 map被置0，利用getter重回JS用户态（避免崩溃）**
5. 触发 GC ，fast property 被混淆为 `SeqTwoByteString`，可通过访问 fast property 越界写入相邻对象的内部数据。

## 涉及知识点：
1. fast property
2. Object.assign
4. normalize
5. map layout
7. getter / runtime call
8. GC
9. SeqTwoByteString

其他：
1. map layout 查询
2. 通过 x.tq 查询对象布局
3. 使用 --soft-abort 关闭 DCHECK

# 完整利用
需要绕过 heap sandbox
具体方法可参考补丁中的回归测试文件，不赘述
1.  [[wasm][sandbox] Fix sandbox escapes via i32 high word (5494364) · Gerrit Code Review (googlesource.com)](https://chromium-review.googlesource.com/c/v8/v8/+/5494364)
2. [[wasm][sandbox] Add WasmTrustedInstanceData::native_module (5529236) · Gerrit Code Review (googlesource.com)](https://chromium-review.googlesource.com/c/v8/v8/+/5529236)